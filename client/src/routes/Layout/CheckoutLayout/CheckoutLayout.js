import React from "react";
import { Outlet, useLocation, Navigate } from "react-router-dom";

import { Bag } from "components/Header/Bag";
import SubFooterMenu from "components/Footer/SubFooterMenu";

import StyledCheckoutLayout from "./StyledCheckoutLayout";

// Redux-related
import { useSelector } from "react-redux";
import {
  selectUser,
  selectUserStatus,
  useIsLoggedIn,
  useUserStatusLoading,
} from "features/user/userSlice";
import Spinner from "components/Spinner";

function CheckoutLayout() {
  const user = useSelector(selectUser);
  const isIdle = useSelector(selectUserStatus) === "idle";
  const isLoggedIn = useIsLoggedIn();
  const isLoading = useUserStatusLoading();
  const location = useLocation();

  if (isIdle) return "";

  let content;

  if (isLoading) {
    content = (
      <div className="checkout-spinner flex-center">
        <Spinner />
      </div>
    );
  } else if (!isLoggedIn || !user) {
    content = (
      <Navigate to="/sign-in" state={{ from: location }} replace={true} />
    );
  } else {
    content = (
      <div>
        <header className="checkout__header flex-spbw">
          <a href="/">
            <svg
              width="50"
              height="56"
              viewBox="0 0 66 56"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                d="M9.84375 37.0312H1.59375C1.07812 37.0312 0.820312 36.7891 0.820312 36.3047V35.5078C0.820312 34.8828 0.984375 34.1875 1.3125 33.4219L11.1328 10.4297C11.2422 10.1641 11.4688 10.0312 11.8125 10.0312H14.3906C14.6406 10.0312 14.7656 10.125 14.7656 10.3125V34.3828H17.2266C17.5391 34.3828 17.6953 34.5 17.6953 34.7344V36.6562C17.6953 36.9062 17.5859 37.0312 17.3672 37.0312H14.7656V41.1094C14.7656 41.9844 15.1953 42.5391 16.0547 42.7734C16.3828 42.8672 16.5469 43.0469 16.5469 43.3125V44.5781C16.5469 44.8594 16.4062 45 16.125 45H8.34375C8.09375 45 7.96875 44.8906 7.96875 44.6719V43.2422C7.96875 43.0078 8.11719 42.8359 8.41406 42.7266C9.36719 42.4141 9.84375 41.7109 9.84375 40.6172V37.0312ZM9.84375 19.875L3.58594 34.3828H9.84375V19.875ZM30.4453 11.2734V40.6406C30.4453 41.4531 30.7422 42.0625 31.3359 42.4688C31.7422 42.7344 31.9453 43.0469 31.9453 43.4062V44.4609C31.9453 44.8203 31.7422 45 31.3359 45H24.0234C23.6797 45 23.5078 44.8359 23.5078 44.5078V43.4062C23.5078 43.0625 23.7109 42.75 24.1172 42.4688C24.7109 42.0469 25.0078 41.4375 25.0078 40.6406V11.2734H23.9766C23.2109 11.2734 22.6406 11.5625 22.2656 12.1406C21.9062 12.7188 21.5781 13.9922 21.2812 15.9609C21.25 16.2266 21.0859 16.3594 20.7891 16.3594H19.875C19.3438 16.3594 19.0781 16.1328 19.0781 15.6797V8.85938C19.0781 8.32812 19.3281 8.0625 19.8281 8.0625C20.1406 8.0625 20.6953 8.125 21.4922 8.25C22.7734 8.45313 23.7422 8.55469 24.3984 8.55469H32.6953C33.1172 8.49219 33.6328 8.40625 34.2422 8.29688C35.1797 8.15625 35.6953 8.08594 35.7891 8.08594C36.2109 8.08594 36.4219 8.28125 36.4219 8.67188V15.6797C36.4219 16.1328 36.2188 16.3594 35.8125 16.3594H34.9219C34.5625 16.3594 34.3438 16.2578 34.2656 16.0547C34.2031 15.8516 34.0938 15.3438 33.9375 14.5312C33.6562 13.1875 33.3672 12.3125 33.0703 11.9062C32.7734 11.4844 32.25 11.2734 31.5 11.2734H30.4453ZM57.3281 29.6484L60.1641 13.5469C60.2109 13.2969 60.2344 13.0469 60.2344 12.7969C60.2344 12.0469 59.875 11.5156 59.1562 11.2031C58.6094 10.9531 58.3359 10.625 58.3359 10.2188V9.1875C58.3359 8.76562 58.5781 8.55469 59.0625 8.55469H64.2891C64.8203 8.55469 65.0859 8.80469 65.0859 9.30469V10.2188C65.0859 10.5156 64.8828 10.7969 64.4766 11.0625C63.7578 11.5469 63.3125 12.2578 63.1406 13.1953L57.4688 44.7422C57.3906 45.2422 57.1719 45.4922 56.8125 45.4922H55.7812C55.5156 45.4922 55.3359 45.2422 55.2422 44.7422L51.375 23.8125L47.5781 44.7422C47.4844 45.2422 47.2734 45.4922 46.9453 45.4922H45.9375C45.625 45.4922 45.4219 45.2422 45.3281 44.7422L39.3281 12.5156C39.2031 11.7656 38.7969 11.2734 38.1094 11.0391C37.7344 10.9141 37.5469 10.6563 37.5469 10.2656V9.16406C37.5469 8.75781 37.7734 8.55469 38.2266 8.55469H45.0703C45.3672 8.55469 45.5156 8.67969 45.5156 8.92969V10.3594C45.5156 10.6094 45.3672 10.7969 45.0703 10.9219C44.5078 11.1719 44.2266 11.6094 44.2266 12.2344C44.2266 12.4219 44.25 12.6562 44.2969 12.9375L47.4141 29.6484L49.8984 15.7734L49.2891 12.5156C49.1641 11.8437 48.75 11.375 48.0469 11.1094C47.7344 10.9844 47.5781 10.7891 47.5781 10.5234V9.02344C47.5781 8.71094 47.7188 8.55469 48 8.55469H55.2656C55.6094 8.55469 55.7812 8.71094 55.7812 9.02344V9.86719C55.7812 10.2578 55.7422 10.5234 55.6641 10.6641C55.6016 10.8047 55.3984 10.9688 55.0547 11.1562C54.4766 11.4531 54.1875 11.875 54.1875 12.4219C54.1875 12.5781 54.2031 12.75 54.2344 12.9375L57.3281 29.6484Z"
                fill="#111111"
              />
            </svg>
          </a>

          <div className="flex-start">
            <div className="checkout__bag-ctn flex-center">
              <Bag />
            </div>
            <a href="/account" className="capitalized-text">
              {user.name.firstName} {user.name.lastName}
            </a>
          </div>
        </header>
        <main className="checkout__content">
          <Outlet />
        </main>
        <footer className="checkout__footer">
          <SubFooterMenu />
        </footer>
      </div>
    );
  }

  return <StyledCheckoutLayout>{content}</StyledCheckoutLayout>;
}

export default CheckoutLayout;
